# 100 - 1. Code Your App

Developing a Docker application is similar to the way you develop an application without Docker. The difference is that while developing for Docker, you're deploying and testing your application or services running within Docker containers in your local environment (either a Linux VM setup by Docker or directly Windows if using Windows Containers).

For the purpose of a universal solution, we subscribe to **gitpod.io**, a service that lets us turn our source code into a Docker container hosted development environment. In our GitHub repositories - where we keep our source code - all one has to do is click the **[Gitpod icon] Open** button near the top of the page when at the start of repository, and gitpod will direct us to this development environment automatically (**note**: the name of the GitHub repository is extended by some random characters, e.g. ```https://agilitygame-home-t4ywwnrcngu.ws-eu111.gitpod.io/```). 

== Gitpod let's you develop in a browser from anywhere, without the need to install any software ==

Gitpod lets us specify the configuration of the development environment in a file, **.gitpod.yml**. For example:

```
# This configuration file was automatically generated by Gitpod.
# Please adjust to your needs (see https://www.gitpod.io/docs/introduction/learn-gitpod/gitpod-yaml)
# and commit this file to your remote git repository to share the goodness with others.

# Learn more from ready-to-use templates: https://www.gitpod.io/docs/introduction/getting-started/quickstart

tasks:
  - init: npm install
```
.gitpod.yml

We base our GitHub repository content and structure on the [GitLab CI/CD test automation example](https://github.com/testmoapp/example-gitlab-automation). It is documented in the article [GitLab CI/CD Test Automation Pipeline & Reporting](https://www.testmo.com/guides/gitlab-ci-test-automation). But we will document it here for our specific case.

## 100 - Local Development Environment

Your CI/CD workflow will run inside a Docker container on GitLab's servers (or on your own servers if your team uses a private GitLab instance). But it's still useful to run code locally, e.g. to see if your tests pass during development or to use the ```npm``` package manager to install new packages.

You could do all this directly on your machine, but it's often useful to run code inside a Docker container as well instead. First, it makes it very easy to run any commands and code in the exact same environment: simply use the same Docker container as you use for your CI pipeline. No need to install any prerequisites or dependencies! And second, it makes things more secure as everything runs inside the container without access to your full machine.

We will simply create a new Docker Compose configuration file in our project directory and tell Docker Compose to use the same ```node``` Docker container that we already use for our GitLab CI workflow:

```
# dev/docker-compose.yml
version: '3'
services:
  node:
    image: node:19
    volumes:
      - ./../:/project
    working_dir: /project
```
dev/docker-compose.yml

We can then easily start our Docker container and run code inside it by using the ```docker compose``` command to launch a shell. We can then run any commands and start our tests inside the container **without affecting our main machine**:

== EXECUTE THE FOLLOWING COMMANDS FROM WITHIN YOUR GITPOD WORKSPACE ==

```
gitpod /workspace/home (main) $ cd dev
gitpod /workspace/home/dev (main) $ docker compose run node bash
[+] Creating 1/1
 ✔ Network dev_default  Created                                                                                                               0.1s 
[+] Running 9/9
 ✔ node 8 layers [⣿⣿⣿⣿⣿⣿⣿⣿]      0B/0B      Pulled                                                                                           29.7s 
   ✔ bd73737482dd Pull complete                                                                                                               0.9s 
   ✔ 6710592d62aa Pull complete                                                                                                               0.6s 
   ✔ 75256935197e Pull complete                                                                                                               1.1s 
   ✔ c1e5026c6457 Pull complete                                                                                                               3.7s 
   ✔ f2e4b4cbd0b8 Pull complete                                                                                                               1.2s 
   ✔ aa0a28bddc08 Pull complete                                                                                                               2.1s 
   ✔ a43acb05766e Pull complete                                                                                                               1.6s 
   ✔ 777f451f077e Pull complete                                                                                                               2.0s 
root@514657c1a1fe:/project# 
```

You are now inside your Docker container (here: ```514657c1a1fe```), containing your code, so any changes are not affecting your Gitpod environment.

To view the files and directories in the current location inside the Docker container, just type ```ls -la```:

```
root@514657c1a1fe:/project# ls -la
total 80
drwxr-xr-x  5 33333 33333  4096 May  7 12:42 .
drwxr-xr-x  1 root  root     21 May  8 08:05 ..
drwxr-xr-x  8 33333 33333  4096 May  8 08:22 .git
-rw-r--r--  1 33333 33333  2047 May  7 12:42 .gitignore
-rw-r--r--  1 33333 33333   275 May  7 12:42 .gitlab-ci.yml
-rw-r--r--  1 33333 33333   396 May  7 12:42 .gitpod.yml
-rw-r--r--  1 33333 33333  1069 May  7 12:42 LICENSE
-rw-r--r--  1 33333 33333   190 May  7 12:43 README.md
drwxr-xr-x  2 33333 33333    32 May  7 12:42 dev
drwxr-xr-x 90 33333 33333  4096 May  7 12:42 node_modules
-rw-r--r--  1 33333 33333 37243 May  7 12:42 package-lock.json
-rw-r--r--  1 33333 33333   394 May  7 12:42 package.json
-rw-r--r--  1 33333 33333   702 May  7 12:42 test.js
root@514657c1a1fe:/project# 
```

## 200 - Setting Up Test Automation

Let's look at our example test automation suite next. You can use pretty much any testing framework, programming language or automation tool with GitLab and the approach we are describing here. For this article we are going to use a simple JavaScript (Node.js) based framework, in our case ***Mocha/Chai***. If your team uses a different programming language such as Ruby, Java, PHP, .NET etc., you would just choose a different framework (and corresponding Docker container).

With the node Docker container we use, everything is already pre-installed and ready to use. So we can just use the npm package manager to install our required packages (i.e. the testing framework we want to use). So inside our development container we will just install these packages:

```
# Run this inside your container
$ npm install --save-dev mocha chai mocha-junit-reporter
```

Running this command will download and install the packages and will also create new package.json and package-lock.json files in our project directory with our dependencies.

**WARNING**: Make sure to also commit these files to your repository. Hence, we would commit from the Gitpod workspace to the GitHub repository. We do not commit ```node_modules``` to our repository, they are prevented from commiting by means of the ```.gitignore``` file.

```
root@514657c1a1fe:/project# npm install --save-dev mocha chai mocha-junit-reporter

removed 5 packages, changed 3 packages, and audited 87 packages in 638ms

20 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
npm notice 
npm notice New major version of npm available! 9.6.3 -> 10.7.0
npm notice Changelog: https://github.com/npm/cli/releases/tag/v10.7.0
npm notice Run npm install -g npm@10.7.0 to update!
npm notice 
root@514657c1a1fe:/project# 
```

When we then check out the code of our repository on another machine or as part of our GitLab CI/CD run in the future, we can easily install all required packages based on these configuration files (e.g. ```package.json```).

We also want to make it easier to run our automated tests. For this we are adding a few script aliases to the ```scripts``` section of the ```package.json``` file:

```
{
  "name": "agility-game-home",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "mocha": "npx mocha",
    "mocha-junit": "npx mocha --reporter node_modules/mocha-junit-reporter --reporter-options jenkinsMode=1,outputs=1,mochaFile=results/mocha-test-results.xml"
  },
  "devDependencies": {
    "chai": "^5.1.0",
    "mocha": "^10.4.0",
    "mocha-junit-reporter": "^2.2.1"
  }
}
```
package.json

We also need an actual test suite for this example project. Mocha/Chai makes it easy to create some simple test cases. Just add a new ```test.js``` file and add some tests like shown in the example below.

```
// test.js
import * as chai from 'chai';
const assert = chai.assert;

describe('files', function () {
    describe('export', function () {
        it('should export pdf', function () {
            assert.isTrue(true);
        });

        it('should export html', function () {
            assert.isTrue(true);
        });

        it('should export yml', function () {
            assert.isTrue(true);
        });

        it('should export text', function () {
            assert.isTrue(true);
        });
    });
	
    describe('import', function () {
        it('should import pdf', function () {
            assert.isTrue(true);
        });

        it('should import html', function () {
            assert.isTrue(true);
        });

        it('should import yml', function () {
            assert.isTrue(true);
        });

        it('should import text', function () {
            assert.isTrue(true);
        });
    });

});
```
test.js

We can first try our tests and run them in our local development container. You can use the script alias we've added above to run the tests; simply run ```npm run mocha``` inside the container. The output should look like this:

```
root@514657c1a1fe:/project# npm run mocha

> agility-game-home@1.0.0 mocha
> npx mocha

  files
    export
      ✔ should export pdf
      ✔ should export html
      ✔ should export yml
      ✔ should export text
    import
      ✔ should import pdf
      ✔ should import html
      ✔ should import yml
      ✔ should import text

  8 passing (8ms)

root@514657c1a1fe:/project#
```

## 300 - Running the Tests from GitLab CI/CD

More
